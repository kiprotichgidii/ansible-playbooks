---
- name: Ensure sudo package is installed
  ansible.builtin.package:
    name: sudo
    state: present
  when: users_manage

- name: Ensure default groups exist
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop: "{{ users_default_groups + [users_sudo_group] }}"
  loop_control:
    label: "{{ item }}"
  when: users_manage

- name: Create local user accounts
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ item.uid | default(omit) }}"
    shell: "{{ item.shell | default(users_default_shell) }}"
    groups: "{{ item.groups | default(users_default_groups) }}"
    append: true
    create_home: true
    state: "{{ item.state | default('present') }}"
  loop: "{{ users_create }}"
  loop_control:
    label: "{{ item.name }}"
  when: users_manage

- name: Install SSH authorized keys for users
  ansible.builtin.authorized_key:
    user: "{{ item.user }}"
    key: "{{ item.key }}"
    state: present
  loop: >-
    {% set result = [] %}
    {% for user in users_create %}
    {%   if user.name in ssh_public_keys %}
    {%     for key in ssh_public_keys[user.name] %}
    {%       set _ = result.append({'user': user.name, 'key': key}) %}
    {%     endfor %}
    {%   endif %}
    {% endfor %}
    {{ result }}
  loop_control:
    label: "{{ item.user }}"
  when:
    - users_manage
    - ssh_public_keys is defined

- name: Setup passwordless sudo for sudo group
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ users_sudo_group }}"
    content: "%{{ users_sudo_group }} ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: "0440"
    validate: visudo -cf %s
  when: users_manage

- name: Remove unwanted user accounts
  ansible.builtin.user:
    name: "{{ item.name }}"
    state: absent
    remove: "{{ item.remove_home | default(false) }}"
  loop: "{{ users_remove }}"
  loop_control:
    label: "{{ item.name }}"
  when: users_manage
